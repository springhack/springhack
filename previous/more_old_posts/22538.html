

<p style="margin: 10px 0px; padding: 0px; border: 0px; box-sizing: border-box; -webkit-font-smoothing: subpixel-antialiased; color: rgb(51, 51, 51); font-family: Exo, -apple-system, &quot;Open Sans&quot;, HelveticaNeue-Light, &quot;Helvetica Neue Light&quot;, &quot;Helvetica Neue&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 22.4px;">这次我们谈谈提交模块。<br style="margin: 0px; padding: 0px; border: 0px; box-sizing: border-box; -webkit-font-smoothing: subpixel-antialiased;" />在写这篇文章之前浏览网络的过程中，我有看到有人讨论过vj这种东西的合法性和道德性；不过在这篇文章里我不会谈这些，我们只关心技术。<br style="margin: 0px; padding: 0px; border: 0px; box-sizing: border-box; -webkit-font-smoothing: subpixel-antialiased;" />我们是用php实现的提交，那么我们不得不使用一种东西：curl。不过php默认是不启用curl支持的，不管你用何种方式，总之让他工作起来就是了，不多说，直接贴代码：</p><blockquote style="margin: 20px 0px; padding: 0px 20px; border-width: 0px 0px 0px 4px; border-left-style: solid; border-left-color: rgb(76, 175, 80); box-sizing: border-box; -webkit-font-smoothing: subpixel-antialiased; color: rgb(119, 119, 119); position: relative; width: 656.75px; font-family: Exo, -apple-system, &quot;Open Sans&quot;, HelveticaNeue-Light, &quot;Helvetica Neue Light&quot;, &quot;Helvetica Neue&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 22.4px;"><p style="margin: 0px; padding: 0px; border: 0px; box-sizing: border-box; -webkit-font-smoothing: subpixel-antialiased;">public function POJ_DataPoster_Worker($user = &quot;skvj01&quot;, $pass =<br style="margin: 0px; padding: 0px; border: 0px; box-sizing: border-box; -webkit-font-smoothing: subpixel-antialiased;" />&quot;forskvj&quot;, $id = &quot;1000&quot;, $lang = &quot;0&quot;, $code = &quot;&quot;, $rid = &quot;&quot;) {<br style="margin: 0px; padding: 0px; border: 0px; box-sizing: border-box; -webkit-font-smoothing: subpixel-antialiased;" />if (DEBUG)<br style="margin: 0px; padding: 0px; border: 0px; box-sizing: border-box; -webkit-font-smoothing: subpixel-antialiased;" />echo &quot;[D] =&gt; $user, $pass, $id, $lang, $rid\n&quot;; //MySQL $this-&gt;db = new dMySQL(); //Infomation $cookie_file =<br style="margin: 0px; padding: 0px; border: 0px; box-sizing: border-box; -webkit-font-smoothing: subpixel-antialiased;" />tempnam(&quot;./cookie&quot;, &quot;cookie&quot;); $login_url = &quot;http://poj.org/login&quot;;<br style="margin: 0px; padding: 0px; border: 0px; box-sizing: border-box; -webkit-font-smoothing: subpixel-antialiased;" />$post_fields = &quot;user_id1=&quot;.$user.&quot;&amp;password1=&quot;.$pass.&quot;&amp;url=/&quot;;<br style="margin: 0px; padding: 0px; border: 0px; box-sizing: border-box; -webkit-font-smoothing: subpixel-antialiased;" />$this-&gt;rid = $rid; $this-&gt;pid = $id; $this-&gt;lang = $lang;<br style="margin: 0px; padding: 0px; border: 0px; box-sizing: border-box; -webkit-font-smoothing: subpixel-antialiased;" />$this-&gt;user = $user; $this-&gt;pass = $pass;<br style="margin: 0px; padding: 0px; border: 0px; box-sizing: border-box; -webkit-font-smoothing: subpixel-antialiased;" />//Login $curl = curl_init($login_url);<br style="margin: 0px; padding: 0px; border: 0px; box-sizing: border-box; -webkit-font-smoothing: subpixel-antialiased;" />curl_setopt($curl, CURLOPT_HEADER, 0); curl_setopt($curl, CURLOPT_RETURNTRANSFER, 1); curl_setopt($curl, CURLOPT_COOKIEJAR,<br style="margin: 0px; padding: 0px; border: 0px; box-sizing: border-box; -webkit-font-smoothing: subpixel-antialiased;" />$cookie_file); curl_setopt($curl, CURLOPT_POST, 1);<br style="margin: 0px; padding: 0px; border: 0px; box-sizing: border-box; -webkit-font-smoothing: subpixel-antialiased;" />curl_setopt($curl, CURLOPT_POSTFIELDS, $post_fields);<br style="margin: 0px; padding: 0px; border: 0px; box-sizing: border-box; -webkit-font-smoothing: subpixel-antialiased;" />$this-&gt;data = curl_exec($curl); curl_close($curl);<br style="margin: 0px; padding: 0px; border: 0px; box-sizing: border-box; -webkit-font-smoothing: subpixel-antialiased;" />//Submit $hint_code = /<span style="margin: 0px; padding: 0px; border: 0px; box-sizing: border-box; -webkit-font-smoothing: subpixel-antialiased;">&quot;//<id style="margin: 0px; padding: 0px; border: 0px; box-sizing: border-box; -webkit-font-smoothing: subpixel-antialiased;">&quot;.$rid.&quot;</id>\n&quot;.</span>/$code; $post_fields =<br style="margin: 0px; padding: 0px; border: 0px; box-sizing: border-box; -webkit-font-smoothing: subpixel-antialiased;" />'problem_id='.$id.'&amp;language='<br style="margin: 0px; padding: 0px; border: 0px; box-sizing: border-box; -webkit-font-smoothing: subpixel-antialiased;" />.$lang.'&amp;encoded=1&amp;source='.urlencode($hint_code);<br style="margin: 0px; padding: 0px; border: 0px; box-sizing: border-box; -webkit-font-smoothing: subpixel-antialiased;" />//print_r(base64_encode($code)); $curl =<br style="margin: 0px; padding: 0px; border: 0px; box-sizing: border-box; -webkit-font-smoothing: subpixel-antialiased;" />curl_init(&quot;http://poj.org/submit&quot;);<br style="margin: 0px; padding: 0px; border: 0px; box-sizing: border-box; -webkit-font-smoothing: subpixel-antialiased;" />curl_setopt($curl, CURLOPT_HEADER, 0); curl_setopt($curl, CURLOPT_RETURNTRANSFER, 1); curl_setopt($curl, CURLOPT_COOKIEFILE,<br style="margin: 0px; padding: 0px; border: 0px; box-sizing: border-box; -webkit-font-smoothing: subpixel-antialiased;" />$cookie_file); curl_setopt($curl, CURLOPT_POST, 1);<br style="margin: 0px; padding: 0px; border: 0px; box-sizing: border-box; -webkit-font-smoothing: subpixel-antialiased;" />curl_setopt($curl, CURLOPT_POSTFIELDS, $post_fields);<br style="margin: 0px; padding: 0px; border: 0px; box-sizing: border-box; -webkit-font-smoothing: subpixel-antialiased;" />$this-&gt;data = curl_exec($curl); curl_close($curl);<br style="margin: 0px; padding: 0px; border: 0px; box-sizing: border-box; -webkit-font-smoothing: subpixel-antialiased;" />@unlink($cookie_file);<br style="margin: 0px; padding: 0px; border: 0px; box-sizing: border-box; -webkit-font-smoothing: subpixel-antialiased;" />//Record Information $this-&gt;info = array(<br style="margin: 0px; padding: 0px; border: 0px; box-sizing: border-box; -webkit-font-smoothing: subpixel-antialiased;" />'id' =&gt; $rid,<br style="margin: 0px; padding: 0px; border: 0px; box-sizing: border-box; -webkit-font-smoothing: subpixel-antialiased;" />'user' =&gt; $user<br style="margin: 0px; padding: 0px; border: 0px; box-sizing: border-box; -webkit-font-smoothing: subpixel-antialiased;" />);<br style="margin: 0px; padding: 0px; border: 0px; box-sizing: border-box; -webkit-font-smoothing: subpixel-antialiased;" />}</p></blockquote><p style="margin: 10px 0px; padding: 0px; border: 0px; box-sizing: border-box; -webkit-font-smoothing: subpixel-antialiased; color: rgb(51, 51, 51); font-family: Exo, -apple-system, &quot;Open Sans&quot;, HelveticaNeue-Light, &quot;Helvetica Neue Light&quot;, &quot;Helvetica Neue&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 22.4px;">这里还是用POJ为例子，POJ提交以后立刻会有记录产生，而HDOJ等则不然，这里就是利用curl模拟提交了一下。</p><blockquote style="margin: 20px 0px; padding: 0px 20px; border-width: 0px 0px 0px 4px; border-left-style: solid; border-left-color: rgb(76, 175, 80); box-sizing: border-box; -webkit-font-smoothing: subpixel-antialiased; color: rgb(119, 119, 119); position: relative; width: 656.75px; font-family: Exo, -apple-system, &quot;Open Sans&quot;, HelveticaNeue-Light, &quot;Helvetica Neue Light&quot;, &quot;Helvetica Neue&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 22.4px;"><p style="margin: 0px; padding: 0px; border: 0px; box-sizing: border-box; -webkit-font-smoothing: subpixel-antialiased;">$pdw = new POJ_DataPoster_Worker($oo_u, $oo_p, $list[$i]['tid'],<br style="margin: 0px; padding: 0px; border: 0px; box-sizing: border-box; -webkit-font-smoothing: subpixel-antialiased;" />$list[$i]['lang'], $list[$i]['code'], $list[$i]['id']); $rrid =<br style="margin: 0px; padding: 0px; border: 0px; box-sizing: border-box; -webkit-font-smoothing: subpixel-antialiased;" />$pdw-&gt;getRunID()</p></blockquote><p style="margin: 10px 0px; padding: 0px; border: 0px; box-sizing: border-box; -webkit-font-smoothing: subpixel-antialiased; color: rgb(51, 51, 51); font-family: Exo, -apple-system, &quot;Open Sans&quot;, HelveticaNeue-Light, &quot;Helvetica Neue Light&quot;, &quot;Helvetica Neue&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 22.4px;">这里创建实例并且提交代码，然后获取RunID，就是远程的纪录ID。上面提到提交后就会产生纪录，这点比较好，迅速的直接抓取就好。当然，抓取不到那就是提交错误，就没有下文了。<br style="margin: 0px; padding: 0px; border: 0px; box-sizing: border-box; -webkit-font-smoothing: subpixel-antialiased;" />当然，抓取到，就是一个死循环了，不断的查询状态，然后更新本地纪录就可以了。</p><p style="margin: 10px 0px; padding: 0px; border: 0px; box-sizing: border-box; -webkit-font-smoothing: subpixel-antialiased; color: rgb(51, 51, 51); font-family: Exo, -apple-system, &quot;Open Sans&quot;, HelveticaNeue-Light, &quot;Helvetica Neue Light&quot;, &quot;Helvetica Neue&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 22.4px;">上面提到的抓取，有一个问题，就是如何判断哪个纪录是你当前提交的纪录，这个有方案如下：</p><blockquote style="margin: 20px 0px; padding: 0px 20px; border-width: 0px 0px 0px 4px; border-left-style: solid; border-left-color: rgb(76, 175, 80); box-sizing: border-box; -webkit-font-smoothing: subpixel-antialiased; color: rgb(119, 119, 119); position: relative; width: 656.75px; font-family: Exo, -apple-system, &quot;Open Sans&quot;, HelveticaNeue-Light, &quot;Helvetica Neue Light&quot;, &quot;Helvetica Neue&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 22.4px;"><p style="margin: 0px; padding: 0px; border: 0px; box-sizing: border-box; -webkit-font-smoothing: subpixel-antialiased;">1.一个账号是一个单独的队列，每次提交一个;<br style="margin: 0px; padding: 0px; border: 0px; box-sizing: border-box; -webkit-font-smoothing: subpixel-antialiased;" />2.每次查询只查询本账号提交的纪录而非所有;<br style="margin: 0px; padding: 0px; border: 0px; box-sizing: border-box; -webkit-font-smoothing: subpixel-antialiased;" />3.给代码加注释，内含一个绝对的ID，用于抓取所有源码并匹配。</p></blockquote><p style="margin: 10px 0px; padding: 0px; border: 0px; box-sizing: border-box; -webkit-font-smoothing: subpixel-antialiased; color: rgb(51, 51, 51); font-family: Exo, -apple-system, &quot;Open Sans&quot;, HelveticaNeue-Light, &quot;Helvetica Neue Light&quot;, &quot;Helvetica Neue&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 22.4px;">这里3对于前两个来说理论上是多余的，只要抓第一个就好了。不过因为每次都是抓取一页，所以顺便就添加了这个机制，保险最重要。</p>