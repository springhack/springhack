

<p><span style="white-space:pre">	</span>本身生活在一个小学校中，但是对计算机的渴望又是那么深，所以深切的想做出点什么东西。鉴于学校的ACM还算玩的比较有意思，所以想，写一个Virtual Judge系统吧，算是给后辈们留下个可玩的东西（其实是和别人打赌写出来2333....）。</p><p><span style="white-space:pre">	</span>设计一个Virtual Judge系统，远比设计一个Online Judge系统的事情少得多，但是仍然不简单（对于没接触过的人来说），首先要解决的问题就是采题。说白了就是去别人的OJ扒题。这里抛弃道德的问题（因为我并没有联系OJ的作者或者管理员2333....），只谈谈技术上的实现。</p><p><span style="white-space:pre">	</span>后端语言采用的是PHP实现，截止我开发出来为止PHP7还没出来（你懂的，频繁跳票），所以基于PHP5.6版本开发。这里我使用了我很久以前简单封装的一个CMS叫做AlxwCMS（其实是不想写用户模块了2333....），我封装了一个MySQL的库用来实现链式调用，所以数据库的配置部分基本略过。</p><p><span style="white-space:pre">	</span>下面说说采题。其实说白了很简单，无非是抓题目的页面。但是需要注意的是，页面中可并不是只有文本，还有图片和其他的东西等。鉴于我们学校所采用的封闭式比赛，那么我们的系统一定要能够隔绝内网与公网，酱紫只有服务器本身联网，其余内网机器只能够看得到我们的系统服务器。</p><p><span style="white-space:pre">	</span>这里的采集直接用PHP函数&nbsp;<a href="http://php.net/file_get_contents" target="_blank">file_get_contents</a>&nbsp;实现。我们的数据库表有一个名字为Problem，用来存储题目，结构如图：</p><p><a href="https://ww1.sinaimg.cn/large/7eb49035jw1f25hm0rhbkj20ev066js3.jpg" target="_blank"><img src="https://ww1.sinaimg.cn/large/7eb49035jw1f25hm0rhbkj20ev066js3.jpg" width="700" alt="" /></a><br /></p><p><span style="white-space:pre">	</span>这里id是我们本地的题目id，递增；pid是远程OJ上面题目的id，当然后面的OJ就是相应的OJ。鉴于题目随时可能改变，这里并没有存储题目内容。如果进行存储，相信会进一步加速页面载入题目的速度。鉴于题目列表是经常展示的页面，这里对题目的标题进行了存储，页面效果如图：</p><p><a href="https://ww4.sinaimg.cn/large/7eb49035jw1f25hquy7j1j20iy0nk76p.jpg" target="_blank"><img src="https://ww4.sinaimg.cn/large/7eb49035jw1f25hquy7j1j20iy0nk76p.jpg" width="700" alt="" /></a><br /></p><p><span style="white-space:pre">	</span>然后就是问题显示页面的渲染效果。这里我获取到页面内容后，写了一个HTML的匹配库，用以实现内容的提取，如图：</p><p><a href="https://ww3.sinaimg.cn/large/7eb49035jw1f25hudwqojj20u01hch3q.jpg" target="_blank"><img src="https://ww3.sinaimg.cn/large/7eb49035jw1f25hudwqojj20u01hch3q.jpg" width="700" alt="" /></a><br /></p><p><span style="white-space:pre">	</span>至于前面所说的页面中的资源，可以通过 .htaccess 配合 mod_rewrite 实现（这里是Apache2），直接贴代码：</p><p><table border="0" width="700" cellspacing="0" cellpadding="0"><tbody><tr><td><p><span class="pl-c1" style="font-family: Consolas, 'Liberation Mono', Menlo, Courier, monospace; line-height: 18.2px; white-space: pre; box-sizing: border-box; color: rgb(0, 134, 179);">.htaccess:</span></p><p><span class="pl-c1" style="font-family: Consolas, 'Liberation Mono', Menlo, Courier, monospace; line-height: 18.2px; white-space: pre; box-sizing: border-box; color: rgb(0, 134, 179);"><span style="white-space:pre">	</span>RewriteEngine</span><span style="color: rgb(51, 51, 51); font-family: Consolas, 'Liberation Mono', Menlo, Courier, monospace; line-height: 18.2px; white-space: pre;"> On</span><br /></p><p><span style="color: rgb(51, 51, 51); font-family: Consolas, 'Liberation Mono', Menlo, Courier, monospace; line-height: 18.2px; white-space: pre;"><span class="pl-c1" style="line-height: 18.2px; box-sizing: border-box; color: rgb(0, 134, 179);"><span style="white-space:pre">	</span>RewriteCond</span><span style="line-height: 18.2px;"> </span><span class="pl-c1" style="line-height: 18.2px; box-sizing: border-box; color: rgb(0, 134, 179);">%{REQUEST_FILENAME}</span><span style="line-height: 18.2px;"> </span><span class="pl-s" style="line-height: 18.2px; box-sizing: border-box; color: rgb(24, 54, 145);">!-f</span><br /></span></p><p><span style="color: rgb(51, 51, 51); font-family: Consolas, 'Liberation Mono', Menlo, Courier, monospace; line-height: 18.2px; white-space: pre;"><span class="pl-s" style="line-height: 18.2px; box-sizing: border-box; color: rgb(24, 54, 145);"><span class="pl-c1" style="line-height: 18.2px; box-sizing: border-box; color: rgb(0, 134, 179);"><span style="white-space:pre">	</span>RewriteCond</span><span style="color: rgb(51, 51, 51); line-height: 18.2px;"> </span><span class="pl-c1" style="line-height: 18.2px; box-sizing: border-box; color: rgb(0, 134, 179);">%{REQUEST_FILENAME}</span><span style="color: rgb(51, 51, 51); line-height: 18.2px;"> </span><span class="pl-s" style="line-height: 18.2px; box-sizing: border-box;">!-d</span><br /></span></span></p><p><span style="color: rgb(51, 51, 51); font-family: Consolas, 'Liberation Mono', Menlo, Courier, monospace; line-height: 18.2px; white-space: pre;"><span class="pl-s" style="line-height: 18.2px; box-sizing: border-box; color: rgb(24, 54, 145);"><span class="pl-c1" style="line-height: 18.2px; box-sizing: border-box; color: rgb(0, 134, 179);"><span style="white-space:pre">	</span>RewriteRule</span><span style="color: rgb(51, 51, 51); line-height: 18.2px;"> </span><span class="pl-sr" style="line-height: 18.2px; box-sizing: border-box;">.</span><span style="color: rgb(51, 51, 51); line-height: 18.2px;"> </span><span class="pl-s" style="line-height: 18.2px; box-sizing: border-box;">./get.php</span><span style="color: rgb(51, 51, 51); line-height: 18.2px;"> </span><span class="pl-sr" style="line-height: 18.2px; box-sizing: border-box;">[L]</span></span></span></p></td></tr></tbody></table><pre style="color: rgb(85, 204, 102); background: rgb(0, 24, 0);">get<span style="color: rgb(128, 128, 48);">.</span>php<span style="color: rgb(128, 0, 128);">:</span>

<span style="color: rgb(128, 128, 48);">&lt;</span><span style="color: rgb(128, 0, 128);">?</span>php <span style="color: rgb(127, 191, 223);">/**</span>
<span style="color: rgb(127, 191, 223);">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Author: SpringHack - springhack@live.cn</span>
<span style="color: rgb(127, 191, 223);">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Last modified: 2015-12-08 10:29:25</span>
<span style="color: rgb(127, 191, 223);">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Filename: get.php</span>
<span style="color: rgb(127, 191, 223);">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Description: Created by SpringHack using vim automatically.</span>
<span style="color: rgb(127, 191, 223);">**/</span> <span style="color: rgb(128, 0, 128);">?</span><span style="color: rgb(128, 128, 48);">&gt;</span>
<span style="color: rgb(128, 128, 48);">&lt;</span><span style="color: rgb(128, 0, 128);">?</span>php
 	require_once<span style="color: rgb(128, 128, 48);">(</span><span style="color: rgb(128, 0, 0);">&quot;</span><span style="color: rgb(204, 85, 85);">api.php</span><span style="color: rgb(128, 0, 0);">&quot;</span><span style="color: rgb(128, 128, 48);">)</span><span style="color: rgb(128, 0, 128);">;</span>
	require_once<span style="color: rgb(128, 128, 48);">(</span><span style="color: rgb(128, 0, 0);">&quot;</span><span style="color: rgb(204, 85, 85);">classes/Problem.php</span><span style="color: rgb(128, 0, 0);">&quot;</span><span style="color: rgb(128, 128, 48);">)</span><span style="color: rgb(128, 0, 128);">;</span>
	$id <span style="color: rgb(128, 128, 48);">=</span> explode<span style="color: rgb(128, 128, 48);">(</span><span style="color: rgb(128, 0, 0);">&quot;</span><span style="color: rgb(204, 85, 85);">id=</span><span style="color: rgb(128, 0, 0);">&quot;</span><span style="color: rgb(128, 128, 48);">,</span> $_SERVER<span style="color: rgb(128, 128, 48);">[</span><span style="color: rgb(128, 0, 0);">&quot;</span><span style="color: rgb(204, 85, 85);">HTTP_REFERER</span><span style="color: rgb(128, 0, 0);">&quot;</span><span style="color: rgb(128, 128, 48);">]</span><span style="color: rgb(128, 128, 48);">)</span><span style="color: rgb(128, 0, 128);">;</span>
	$id <span style="color: rgb(128, 128, 48);">=</span> isset<span style="color: rgb(128, 128, 48);">(</span>$id<span style="color: rgb(128, 128, 48);">[</span><span style="color: rgb(119, 140, 119);">1</span><span style="color: rgb(128, 128, 48);">]</span><span style="color: rgb(128, 128, 48);">)</span><span style="color: rgb(128, 0, 128);">?</span>$id<span style="color: rgb(128, 128, 48);">[</span><span style="color: rgb(119, 140, 119);">1</span><span style="color: rgb(128, 128, 48);">]</span><span style="color: rgb(128, 0, 128);">:</span><span style="color: rgb(119, 140, 119);">0</span><span style="color: rgb(128, 0, 128);">;</span>
	$db <span style="color: rgb(128, 128, 48);">=</span> new MySQL<span style="color: rgb(128, 128, 48);">(</span><span style="color: rgb(128, 128, 48);">)</span><span style="color: rgb(128, 0, 128);">;</span>
	$info <span style="color: rgb(128, 128, 48);">=</span> $db<span style="color: rgb(128, 128, 48);">-</span><span style="color: rgb(128, 128, 48);">&gt;</span>from<span style="color: rgb(128, 128, 48);">(</span><span style="color: rgb(128, 0, 0);">&quot;</span><span style="color: rgb(204, 85, 85);">Problem</span><span style="color: rgb(128, 0, 0);">&quot;</span><span style="color: rgb(128, 128, 48);">)</span><span style="color: rgb(128, 128, 48);">-</span><span style="color: rgb(128, 128, 48);">&gt;</span>where<span style="color: rgb(128, 128, 48);">(</span><span style="color: rgb(128, 0, 0);">&quot;</span><span style="color: rgb(204, 85, 85);">`id` = '</span><span style="color: rgb(128, 0, 0);">&quot;</span><span style="color: rgb(128, 128, 48);">.</span>$id<span style="color: rgb(128, 128, 48);">.</span><span style="color: rgb(128, 0, 0);">&quot;</span><span style="color: rgb(204, 85, 85);">'</span><span style="color: rgb(128, 0, 0);">&quot;</span><span style="color: rgb(128, 128, 48);">)</span><span style="color: rgb(128, 128, 48);">-</span><span style="color: rgb(128, 128, 48);">&gt;</span><span style="color: rgb(64, 0, 0);">select</span><span style="color: rgb(128, 128, 48);">(</span><span style="color: rgb(128, 128, 48);">)</span><span style="color: rgb(128, 128, 48);">-</span><span style="color: rgb(128, 128, 48);">&gt;</span>fetch_one<span style="color: rgb(128, 128, 48);">(</span><span style="color: rgb(128, 128, 48);">)</span><span style="color: rgb(128, 0, 128);">;</span>
	$prefix <span style="color: rgb(128, 128, 48);">=</span> <span style="color: rgb(128, 0, 0);">&quot;</span><span style="color: rgb(128, 0, 0);">&quot;</span><span style="color: rgb(128, 0, 128);">;</span>
	<span style="color: rgb(80, 128, 80); "><strong>switch</strong></span> <span style="color: rgb(128, 128, 48);">(</span>$info<span style="color: rgb(128, 128, 48);">[</span><span style="color: rgb(204, 85, 85);">'oj'</span><span style="color: rgb(128, 128, 48);">]</span><span style="color: rgb(128, 128, 48);">)</span>
	<span style="color: rgb(128, 0, 128);">{</span>
		<span style="color: rgb(80, 128, 80); "><strong>case </strong></span><span style="color: rgb(128, 0, 0);">&quot;</span><span style="color: rgb(204, 85, 85);">POJ</span><span style="color: rgb(128, 0, 0);">&quot;</span><span style="color: rgb(227, 74, 220);">:</span>
			$prefix <span style="color: rgb(128, 128, 48);">=</span> <span style="color: rgb(128, 0, 0);">&quot;</span><span style="color: rgb(204, 85, 85);">http://poj.org</span><span style="color: rgb(128, 0, 0);">&quot;</span><span style="color: rgb(128, 0, 128);">;</span>
		<span style="color: rgb(80, 128, 80); "><strong>break</strong></span><span style="color: rgb(128, 0, 128);">;</span>
		<span style="color: rgb(80, 128, 80); "><strong>case </strong></span><span style="color: rgb(128, 0, 0);">&quot;</span><span style="color: rgb(204, 85, 85);">HDOJ</span><span style="color: rgb(128, 0, 0);">&quot;</span><span style="color: rgb(227, 74, 220);">:</span>
			$prefix <span style="color: rgb(128, 128, 48);">=</span> <span style="color: rgb(128, 0, 0);">&quot;</span><span style="color: rgb(204, 85, 85);">http://acm.hdu.edu.cn</span><span style="color: rgb(128, 0, 0);">&quot;</span><span style="color: rgb(128, 0, 128);">;</span>
		<span style="color: rgb(80, 128, 80); "><strong>break</strong></span><span style="color: rgb(128, 0, 128);">;</span>
<span style="color: rgb(227, 74, 220);">		</span><span style="color: rgb(80, 128, 80); "><strong>default</strong></span><span style="color: rgb(227, 74, 220);">:</span>
		<span style="color: rgb(80, 128, 80); "><strong>break</strong></span><span style="color: rgb(128, 0, 128);">;</span>
	<span style="color: rgb(128, 0, 128);">}</span>
	echo file_get_contents<span style="color: rgb(128, 128, 48);">(</span>$prefix<span style="color: rgb(128, 128, 48);">.</span>$_SERVER<span style="color: rgb(128, 128, 48);">[</span><span style="color: rgb(128, 0, 0);">&quot;</span><span style="color: rgb(204, 85, 85);">REQUEST_URI</span><span style="color: rgb(128, 0, 0);">&quot;</span><span style="color: rgb(128, 128, 48);">]</span><span style="color: rgb(128, 128, 48);">)</span><span style="color: rgb(128, 0, 128);">;</span>
<span style="color: rgb(128, 0, 128);">?</span><span style="color: rgb(128, 128, 48);">&gt;</span></pre></p><p><span style="white-space:pre">	</span>这里我就不多说了，贴上我的项目地址，后面的博文还会分析Virtual Judge系统其他部分的实现，传送门：<a href="https://github.com/springhack/sk_vjudge" target="_blank">https://github.com/springhack/sk_vjudge</a></p><p><br /></p>