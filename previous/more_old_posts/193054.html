

<p><span style="white-space:pre">	</span>就是操作系统的实验，代码在这备份一下0.0</p><p><pre style="color: rgb(85, 204, 102); background: rgb(0, 24, 0);"><span style="color: rgb(0, 74, 67);">#</span><span style="color: rgb(0, 74, 67);">include </span><span style="color: rgb(128, 0, 0);">&lt;</span><span style="color: rgb(64, 1, 90);">windows.h</span><span style="color: rgb(128, 0, 0);">&gt;</span>
<span style="color: rgb(0, 74, 67);">#</span><span style="color: rgb(0, 74, 67);">include </span><span style="color: rgb(128, 0, 0);">&lt;</span><span style="color: rgb(64, 1, 90);">stdio.h</span><span style="color: rgb(128, 0, 0);">&gt;</span><span style="color: rgb(0, 74, 67);">		</span><span style="color: rgb(185, 105, 105);">//getchar()</span>
<span style="color: rgb(0, 74, 67);">#</span><span style="color: rgb(0, 74, 67);">include </span><span style="color: rgb(128, 0, 0);">&lt;</span><span style="color: rgb(64, 1, 90);">stdlib.h</span><span style="color: rgb(128, 0, 0);">&gt;</span><span style="color: rgb(0, 74, 67);">		</span><span style="color: rgb(185, 105, 105);">//rand()</span>
     
<span style="color: rgb(80, 128, 80); "><strong>const</strong></span> <span style="color: rgb(80, 128, 80); "><strong>int</strong></span> SIZE_OF_BUFFER <span style="color: rgb(128, 128, 48);">=</span> <span style="color: rgb(119, 140, 119);">10</span><span style="color: rgb(128, 0, 128);">;</span>   <span style="color: rgb(185, 105, 105);">//缓冲区长度</span>
<span style="color: rgb(80, 128, 80); "><strong>int</strong></span> ProductID <span style="color: rgb(128, 128, 48);">=</span> <span style="color: rgb(119, 140, 119);">0</span><span style="color: rgb(128, 0, 128);">;</span>               <span style="color: rgb(185, 105, 105);">//产品号</span>
<span style="color: rgb(80, 128, 80); "><strong>int</strong></span> ConsumeID <span style="color: rgb(128, 128, 48);">=</span> <span style="color: rgb(119, 140, 119);">0</span><span style="color: rgb(128, 0, 128);">;</span>               <span style="color: rgb(185, 105, 105);">//将被消耗的产品号</span>
<span style="color: rgb(80, 128, 80); "><strong>int</strong></span> in <span style="color: rgb(128, 128, 48);">=</span> <span style="color: rgb(119, 140, 119);">0</span><span style="color: rgb(128, 0, 128);">;</span>                      <span style="color: rgb(185, 105, 105);">//产品进缓冲区时的下标</span>
<span style="color: rgb(80, 128, 80); "><strong>int</strong></span> out <span style="color: rgb(128, 128, 48);">=</span> <span style="color: rgb(119, 140, 119);">0</span><span style="color: rgb(128, 0, 128);">;</span>                     <span style="color: rgb(185, 105, 105);">//产品出缓冲区时的下标</span>
     
<span style="color: rgb(80, 128, 80); "><strong>int</strong></span> g_buffer<span style="color: rgb(128, 128, 48);">[</span><span style="color: rgb(119, 140, 119);">10</span><span style="color: rgb(128, 128, 48);">]</span><span style="color: rgb(128, 0, 128);">;</span>               <span style="color: rgb(185, 105, 105);">//缓冲区,长度等于SIZE_OF_BUFFER</span>

<span style="color: rgb(80, 128, 80); "><strong>int</strong></span> g_continue <span style="color: rgb(128, 128, 48);">=</span> <span style="color: rgb(119, 140, 119);">1</span><span style="color: rgb(128, 0, 128);">;</span>                     <span style="color: rgb(185, 105, 105);">//控制程序结束</span>
<span style="color: rgb(96, 48, 0);">HANDLE</span> g_hMutex<span style="color: rgb(128, 0, 128);">;</span>                            <span style="color: rgb(185, 105, 105);">//用于线程间的互斥</span>
<span style="color: rgb(96, 48, 0);">HANDLE</span> g_hFullItems<span style="color: rgb(128, 0, 128);">;</span>                        <span style="color: rgb(185, 105, 105);">//缓冲区中被占用的项</span>
<span style="color: rgb(96, 48, 0);">HANDLE</span> g_hEmptyItems<span style="color: rgb(128, 0, 128);">;</span>                       <span style="color: rgb(185, 105, 105);">//缓冲区中的空项</span>
     
<span style="color: rgb(96, 48, 0);">DWORD</span>  <span style="color: rgb(96, 48, 0);">WINAPI</span> Producer<span style="color: rgb(128, 128, 48);">(</span><span style="color: rgb(96, 48, 0);">LPVOID</span><span style="color: rgb(128, 128, 48);">)</span><span style="color: rgb(128, 0, 128);">;</span>              <span style="color: rgb(185, 105, 105);">//生产者线程</span>
<span style="color: rgb(96, 48, 0);">DWORD</span>  <span style="color: rgb(96, 48, 0);">WINAPI</span> Consumer<span style="color: rgb(128, 128, 48);">(</span><span style="color: rgb(96, 48, 0);">LPVOID</span><span style="color: rgb(128, 128, 48);">)</span><span style="color: rgb(128, 0, 128);">;</span>              <span style="color: rgb(185, 105, 105);">//消费者线程</span>

<span style="color: rgb(80, 128, 80); "><strong>void</strong></span> Produce<span style="color: rgb(128, 128, 48);">(</span><span style="color: rgb(128, 128, 48);">)</span><span style="color: rgb(128, 0, 128);">;</span>
<span style="color: rgb(80, 128, 80); "><strong>void</strong></span> Append<span style="color: rgb(128, 128, 48);">(</span><span style="color: rgb(128, 128, 48);">)</span><span style="color: rgb(128, 0, 128);">;</span> 
<span style="color: rgb(80, 128, 80); "><strong>void</strong></span> Take<span style="color: rgb(128, 128, 48);">(</span><span style="color: rgb(128, 128, 48);">)</span><span style="color: rgb(128, 0, 128);">;</span>
<span style="color: rgb(80, 128, 80); "><strong>void</strong></span> Consume<span style="color: rgb(128, 128, 48);">(</span><span style="color: rgb(128, 128, 48);">)</span><span style="color: rgb(128, 0, 128);">;</span>
     
<span style="color: rgb(80, 128, 80); "><strong>int</strong></span> <span style="color: rgb(64, 0, 0);">main</span><span style="color: rgb(128, 128, 48);">(</span><span style="color: rgb(128, 128, 48);">)</span>
<span style="color: rgb(128, 0, 128);">{</span>
		<span style="color: rgb(80, 128, 80); "><strong>int</strong></span> i<span style="color: rgb(128, 0, 128);">;</span>
		<span style="color: rgb(80, 128, 80); "><strong>const</strong></span> <span style="color: rgb(80, 128, 80); "><strong>int</strong></span> PRODUCERS_COUNT <span style="color: rgb(128, 128, 48);">=</span><span style="color: rgb(119, 140, 119);">3</span><span style="color: rgb(128, 0, 128);">;</span>       <span style="color: rgb(185, 105, 105);">//生产者的个数</span>
		<span style="color: rgb(80, 128, 80); "><strong>const</strong></span> <span style="color: rgb(80, 128, 80); "><strong>int</strong></span> CONSUMERS_COUNT <span style="color: rgb(128, 128, 48);">=</span><span style="color: rgb(119, 140, 119);">2</span><span style="color: rgb(128, 0, 128);">;</span>       <span style="color: rgb(185, 105, 105);">//消费者的个数</span>

		<span style="color: rgb(185, 105, 105);">//总的线程数</span>
		<span style="color: rgb(80, 128, 80); "><strong>const</strong></span> <span style="color: rgb(80, 128, 80); "><strong>int</strong></span> THREADS_COUNT <span style="color: rgb(128, 128, 48);">=</span> PRODUCERS_COUNT<span style="color: rgb(128, 128, 48);">+</span>CONSUMERS_COUNT<span style="color: rgb(128, 0, 128);">;</span>
		

		<span style="color: rgb(96, 48, 0);">HANDLE</span> <span style="color: rgb(128, 128, 48);">*</span>hThreads <span style="color: rgb(128, 128, 48);">=</span> <span style="color: rgb(128, 128, 48);">(</span><span style="color: rgb(96, 48, 0);">HANDLE</span><span style="color: rgb(128, 128, 48);">*</span><span style="color: rgb(128, 128, 48);">)</span><span style="color: rgb(96, 48, 0);">malloc</span><span style="color: rgb(128, 128, 48);">(</span><span style="color: rgb(80, 128, 80); "><strong>sizeof</strong></span><span style="color: rgb(128, 128, 48);">(</span><span style="color: rgb(96, 48, 0);">HANDLE</span><span style="color: rgb(128, 128, 48);">)</span><span style="color: rgb(128, 128, 48);">*</span>THREADS_COUNT<span style="color: rgb(128, 128, 48);">)</span><span style="color: rgb(128, 0, 128);">;</span>		<span style="color: rgb(185, 105, 105);">//各线程的handle</span>
		<span style="color: rgb(96, 48, 0);">DWORD</span> <span style="color: rgb(128, 128, 48);">*</span>producerID <span style="color: rgb(128, 128, 48);">=</span> <span style="color: rgb(128, 128, 48);">(</span><span style="color: rgb(96, 48, 0);">DWORD</span><span style="color: rgb(128, 128, 48);">*</span><span style="color: rgb(128, 128, 48);">)</span><span style="color: rgb(96, 48, 0);">malloc</span><span style="color: rgb(128, 128, 48);">(</span><span style="color: rgb(80, 128, 80); "><strong>sizeof</strong></span><span style="color: rgb(128, 128, 48);">(</span><span style="color: rgb(96, 48, 0);">DWORD</span><span style="color: rgb(128, 128, 48);">)</span><span style="color: rgb(128, 128, 48);">*</span>PRODUCERS_COUNT<span style="color: rgb(128, 128, 48);">)</span><span style="color: rgb(128, 0, 128);">;</span>		<span style="color: rgb(185, 105, 105);">//生产者线程的标识符</span>
		<span style="color: rgb(96, 48, 0);">DWORD</span> <span style="color: rgb(128, 128, 48);">*</span>consumerID <span style="color: rgb(128, 128, 48);">=</span> <span style="color: rgb(128, 128, 48);">(</span><span style="color: rgb(96, 48, 0);">DWORD</span><span style="color: rgb(128, 128, 48);">*</span><span style="color: rgb(128, 128, 48);">)</span><span style="color: rgb(96, 48, 0);">malloc</span><span style="color: rgb(128, 128, 48);">(</span><span style="color: rgb(80, 128, 80); "><strong>sizeof</strong></span><span style="color: rgb(128, 128, 48);">(</span><span style="color: rgb(96, 48, 0);">DWORD</span><span style="color: rgb(128, 128, 48);">)</span><span style="color: rgb(128, 128, 48);">*</span>CONSUMERS_COUNT<span style="color: rgb(128, 128, 48);">)</span><span style="color: rgb(128, 0, 128);">;</span>		<span style="color: rgb(185, 105, 105);">//消费者线程的标识符</span>


        <span style="color: rgb(185, 105, 105);">//创建各个互斥信号</span>
        g_hMutex <span style="color: rgb(128, 128, 48);">=</span> <span style="color: rgb(64, 0, 0);">CreateMutex</span><span style="color: rgb(128, 128, 48);">(</span><span style="color: rgb(125, 0, 69);">NULL</span><span style="color: rgb(128, 128, 48);">,</span>FALSE<span style="color: rgb(128, 128, 48);">,</span><span style="color: rgb(125, 0, 69);">NULL</span><span style="color: rgb(128, 128, 48);">)</span><span style="color: rgb(128, 0, 128);">;</span>
        g_hFullItems <span style="color: rgb(128, 128, 48);">=</span> <span style="color: rgb(64, 0, 0);">CreateSemaphore</span><span style="color: rgb(128, 128, 48);">(</span><span style="color: rgb(125, 0, 69);">NULL</span><span style="color: rgb(128, 128, 48);">,</span><span style="color: rgb(119, 140, 119);">0</span><span style="color: rgb(128, 128, 48);">,</span>SIZE_OF_BUFFER<span style="color: rgb(128, 128, 48);">,</span><span style="color: rgb(125, 0, 69);">NULL</span><span style="color: rgb(128, 128, 48);">)</span><span style="color: rgb(128, 0, 128);">;</span><span style="color: rgb(185, 105, 105);">//创建信号灯,createsemaphore常常被用作多线程同步</span>
        g_hEmptyItems <span style="color: rgb(128, 128, 48);">=</span> <span style="color: rgb(64, 0, 0);">CreateSemaphore</span><span style="color: rgb(128, 128, 48);">(</span><span style="color: rgb(125, 0, 69);">NULL</span><span style="color: rgb(128, 128, 48);">,</span>SIZE_OF_BUFFER<span style="color: rgb(128, 128, 48);">,</span> SIZE_OF_BUFFER<span style="color: rgb(128, 128, 48);">,</span><span style="color: rgb(125, 0, 69);">NULL</span><span style="color: rgb(128, 128, 48);">)</span><span style="color: rgb(128, 0, 128);">;</span>
        
		<span style="color: rgb(185, 105, 105);">//缓冲区初始化</span>
		<span style="color: rgb(80, 128, 80); "><strong>for</strong></span> <span style="color: rgb(128, 128, 48);">(</span>i <span style="color: rgb(128, 128, 48);">=</span> <span style="color: rgb(119, 140, 119);">0</span><span style="color: rgb(128, 0, 128);">;</span> i<span style="color: rgb(128, 128, 48);">&lt;</span> SIZE_OF_BUFFER<span style="color: rgb(128, 0, 128);">;</span><span style="color: rgb(128, 128, 48);">+</span><span style="color: rgb(128, 128, 48);">+</span>i<span style="color: rgb(128, 128, 48);">)</span>
		<span style="color: rgb(128, 0, 128);">{</span>
            g_buffer<span style="color: rgb(128, 128, 48);">[</span>i<span style="color: rgb(128, 128, 48);">]</span> <span style="color: rgb(128, 128, 48);">=</span> <span style="color: rgb(128, 128, 48);">-</span><span style="color: rgb(119, 140, 119);">1</span><span style="color: rgb(128, 0, 128);">;</span>   <span style="color: rgb(185, 105, 105);">//当值为-1时该项为空</span>
        <span style="color: rgb(128, 0, 128);">}</span>    
     
        <span style="color: rgb(185, 105, 105);">//创建生产者线程</span>
        <span style="color: rgb(80, 128, 80); "><strong>for</strong></span> <span style="color: rgb(128, 128, 48);">(</span> i<span style="color: rgb(128, 128, 48);">=</span><span style="color: rgb(119, 140, 119);">0</span><span style="color: rgb(128, 0, 128);">;</span>i<span style="color: rgb(128, 128, 48);">&lt;</span>PRODUCERS_COUNT<span style="color: rgb(128, 0, 128);">;</span><span style="color: rgb(128, 128, 48);">+</span><span style="color: rgb(128, 128, 48);">+</span>i<span style="color: rgb(128, 128, 48);">)</span><span style="color: rgb(128, 0, 128);">{</span>
            hThreads<span style="color: rgb(128, 128, 48);">[</span>i<span style="color: rgb(128, 128, 48);">]</span>
               <span style="color: rgb(128, 128, 48);">=</span><span style="color: rgb(64, 0, 0);">CreateThread</span><span style="color: rgb(128, 128, 48);">(</span><span style="color: rgb(125, 0, 69);">NULL</span><span style="color: rgb(128, 128, 48);">,</span><span style="color: rgb(119, 140, 119);">0</span><span style="color: rgb(128, 128, 48);">,</span>Producer<span style="color: rgb(128, 128, 48);">,</span><span style="color: rgb(125, 0, 69);">NULL</span><span style="color: rgb(128, 128, 48);">,</span><span style="color: rgb(119, 140, 119);">0</span><span style="color: rgb(128, 128, 48);">,</span><span style="color: rgb(128, 128, 48);">&amp;</span>producerID<span style="color: rgb(128, 128, 48);">[</span>i<span style="color: rgb(128, 128, 48);">]</span><span style="color: rgb(128, 128, 48);">)</span><span style="color: rgb(128, 0, 128);">;</span><span style="color: rgb(185, 105, 105);">//CreateThread��window提供的API函数</span>
            <span style="color: rgb(80, 128, 80); "><strong>if</strong></span> <span style="color: rgb(128, 128, 48);">(</span>hThreads<span style="color: rgb(128, 128, 48);">[</span>i<span style="color: rgb(128, 128, 48);">]</span><span style="color: rgb(128, 128, 48);">=</span><span style="color: rgb(128, 128, 48);">=</span><span style="color: rgb(125, 0, 69);">NULL</span><span style="color: rgb(128, 128, 48);">)</span> <span style="color: rgb(80, 128, 80); "><strong>return</strong></span> <span style="color: rgb(128, 128, 48);">-</span><span style="color: rgb(119, 140, 119);">1</span><span style="color: rgb(128, 0, 128);">;</span>                       <span style="color: rgb(185, 105, 105);">//用此函数可创建一个线程</span>
        <span style="color: rgb(128, 0, 128);">}</span>
        <span style="color: rgb(185, 105, 105);">//创建消费者线程</span>
        <span style="color: rgb(80, 128, 80); "><strong>for</strong></span> <span style="color: rgb(128, 128, 48);">(</span>i<span style="color: rgb(128, 128, 48);">=</span><span style="color: rgb(119, 140, 119);">0</span><span style="color: rgb(128, 0, 128);">;</span>i<span style="color: rgb(128, 128, 48);">&lt;</span>CONSUMERS_COUNT<span style="color: rgb(128, 0, 128);">;</span><span style="color: rgb(128, 128, 48);">+</span><span style="color: rgb(128, 128, 48);">+</span>i<span style="color: rgb(128, 128, 48);">)</span><span style="color: rgb(128, 0, 128);">{</span>
            hThreads<span style="color: rgb(128, 128, 48);">[</span>PRODUCERS_COUNT<span style="color: rgb(128, 128, 48);">+</span>i<span style="color: rgb(128, 128, 48);">]</span> <span style="color: rgb(128, 128, 48);">=</span><span style="color: rgb(64, 0, 0);">CreateThread</span><span style="color: rgb(128, 128, 48);">(</span><span style="color: rgb(125, 0, 69);">NULL</span><span style="color: rgb(128, 128, 48);">,</span><span style="color: rgb(119, 140, 119);">0</span><span style="color: rgb(128, 128, 48);">,</span>Consumer<span style="color: rgb(128, 128, 48);">,</span><span style="color: rgb(125, 0, 69);">NULL</span><span style="color: rgb(128, 128, 48);">,</span><span style="color: rgb(119, 140, 119);">0</span><span style="color: rgb(128, 128, 48);">,</span><span style="color: rgb(128, 128, 48);">&amp;</span>consumerID<span style="color: rgb(128, 128, 48);">[</span>i<span style="color: rgb(128, 128, 48);">]</span><span style="color: rgb(128, 128, 48);">)</span><span style="color: rgb(128, 0, 128);">;</span>
            <span style="color: rgb(80, 128, 80); "><strong>if</strong></span> <span style="color: rgb(128, 128, 48);">(</span>hThreads<span style="color: rgb(128, 128, 48);">[</span>i<span style="color: rgb(128, 128, 48);">]</span><span style="color: rgb(128, 128, 48);">=</span><span style="color: rgb(128, 128, 48);">=</span><span style="color: rgb(125, 0, 69);">NULL</span><span style="color: rgb(128, 128, 48);">)</span> <span style="color: rgb(80, 128, 80); "><strong>return</strong></span> <span style="color: rgb(128, 128, 48);">-</span><span style="color: rgb(119, 140, 119);">1</span><span style="color: rgb(128, 0, 128);">;</span>
        <span style="color: rgb(128, 0, 128);">}</span>
     
       <span style="color: rgb(80, 128, 80); "><strong>while</strong></span><span style="color: rgb(128, 128, 48);">(</span>g_continue<span style="color: rgb(128, 128, 48);">)</span><span style="color: rgb(128, 0, 128);">{</span>
            <span style="color: rgb(80, 128, 80); "><strong>if</strong></span><span style="color: rgb(128, 128, 48);">(</span><span style="color: rgb(96, 48, 0);">getchar</span><span style="color: rgb(128, 128, 48);">(</span><span style="color: rgb(128, 128, 48);">)</span><span style="color: rgb(128, 128, 48);">)</span><span style="color: rgb(128, 0, 128);">{</span>  <span style="color: rgb(185, 105, 105);">//按回车后终止程序运行</span>
                g_continue <span style="color: rgb(128, 128, 48);">=</span> <span style="color: rgb(119, 140, 119);">0</span><span style="color: rgb(128, 0, 128);">;</span>
            <span style="color: rgb(128, 0, 128);">}</span>
       <span style="color: rgb(128, 0, 128);">}</span>  
	   
        <span style="color: rgb(80, 128, 80); "><strong>return</strong></span> <span style="color: rgb(119, 140, 119);">0</span><span style="color: rgb(128, 0, 128);">;</span>
    <span style="color: rgb(128, 0, 128);">}</span>

<span style="color: rgb(185, 105, 105);">//生产者</span>
 <span style="color: rgb(96, 48, 0);">DWORD</span>  <span style="color: rgb(96, 48, 0);">WINAPI</span> Producer<span style="color: rgb(128, 128, 48);">(</span><span style="color: rgb(96, 48, 0);">LPVOID</span> lpPara<span style="color: rgb(128, 128, 48);">)</span>
    <span style="color: rgb(128, 0, 128);">{</span>
        <span style="color: rgb(80, 128, 80); "><strong>while</strong></span><span style="color: rgb(128, 128, 48);">(</span>g_continue<span style="color: rgb(128, 128, 48);">)</span><span style="color: rgb(128, 0, 128);">{</span>
            <span style="color: rgb(80, 128, 80); "><strong>int</strong></span> i<span style="color: rgb(128, 128, 48);">=</span><span style="color: rgb(96, 48, 0);">rand</span><span style="color: rgb(128, 128, 48);">(</span><span style="color: rgb(128, 128, 48);">)</span><span style="color: rgb(128, 128, 48);">%</span><span style="color: rgb(119, 140, 119);">5</span><span style="color: rgb(128, 0, 128);">;</span>
            <span style="color: rgb(64, 0, 0);">Sleep</span><span style="color: rgb(128, 128, 48);">(</span>i<span style="color: rgb(128, 128, 48);">*</span><span style="color: rgb(119, 140, 119);">1000</span><span style="color: rgb(128, 128, 48);">)</span><span style="color: rgb(128, 0, 128);">;</span>
                  <span style="color: rgb(64, 0, 0);">WaitForSingleObject</span><span style="color: rgb(128, 128, 48);">(</span>g_hEmptyItems<span style="color: rgb(128, 128, 48);">,</span>INFINITE<span style="color: rgb(128, 128, 48);">)</span>         <span style="color: rgb(128, 0, 128);">;</span><span style="color: rgb(185, 105, 105);">//等待信号灯</span>
                <span style="color: rgb(64, 0, 0);">WaitForSingleObject</span><span style="color: rgb(128, 128, 48);">(</span>g_hMutex<span style="color: rgb(128, 128, 48);">,</span>INFINITE<span style="color: rgb(128, 128, 48);">)</span>                          <span style="color: rgb(128, 0, 128);">;</span>
            Produce<span style="color: rgb(128, 128, 48);">(</span><span style="color: rgb(128, 128, 48);">)</span><span style="color: rgb(128, 0, 128);">;</span>
            Append<span style="color: rgb(128, 128, 48);">(</span><span style="color: rgb(128, 128, 48);">)</span><span style="color: rgb(128, 0, 128);">;</span> 
                  <span style="color: rgb(64, 0, 0);">ReleaseMutex</span><span style="color: rgb(128, 128, 48);">(</span>g_hMutex<span style="color: rgb(128, 128, 48);">)</span>                     <span style="color: rgb(128, 0, 128);">;</span>
                 <span style="color: rgb(64, 0, 0);">ReleaseSemaphore</span><span style="color: rgb(128, 128, 48);">(</span>g_hFullItems<span style="color: rgb(128, 128, 48);">,</span><span style="color: rgb(119, 140, 119);">1</span><span style="color: rgb(128, 128, 48);">,</span><span style="color: rgb(125, 0, 69);">NULL</span><span style="color: rgb(128, 128, 48);">)</span>           <span style="color: rgb(128, 0, 128);">;</span>
       <span style="color: rgb(128, 0, 128);">}</span>
        <span style="color: rgb(80, 128, 80); "><strong>return</strong></span> <span style="color: rgb(119, 140, 119);">0</span><span style="color: rgb(128, 0, 128);">;</span>
    <span style="color: rgb(128, 0, 128);">}</span>
     
    <span style="color: rgb(185, 105, 105);">//消费者</span>
    <span style="color: rgb(96, 48, 0);">DWORD</span>  <span style="color: rgb(96, 48, 0);">WINAPI</span> Consumer<span style="color: rgb(128, 128, 48);">(</span><span style="color: rgb(96, 48, 0);">LPVOID</span> lpPara<span style="color: rgb(128, 128, 48);">)</span>
    <span style="color: rgb(128, 0, 128);">{</span>
        <span style="color: rgb(80, 128, 80); "><strong>while</strong></span><span style="color: rgb(128, 128, 48);">(</span>g_continue<span style="color: rgb(128, 128, 48);">)</span><span style="color: rgb(128, 0, 128);">{</span>
            <span style="color: rgb(80, 128, 80); "><strong>int</strong></span> i<span style="color: rgb(128, 128, 48);">=</span><span style="color: rgb(96, 48, 0);">rand</span><span style="color: rgb(128, 128, 48);">(</span><span style="color: rgb(128, 128, 48);">)</span><span style="color: rgb(128, 128, 48);">%</span><span style="color: rgb(119, 140, 119);">5</span><span style="color: rgb(128, 0, 128);">;</span>
            <span style="color: rgb(64, 0, 0);">Sleep</span><span style="color: rgb(128, 128, 48);">(</span>i<span style="color: rgb(128, 128, 48);">*</span><span style="color: rgb(119, 140, 119);">1000</span><span style="color: rgb(128, 128, 48);">)</span><span style="color: rgb(128, 0, 128);">;</span><span style="color: rgb(185, 105, 105);">//该线程释放当前的控制权1500毫秒,让系统调度其他线程</span>
                   <span style="color: rgb(64, 0, 0);">WaitForSingleObject</span><span style="color: rgb(128, 128, 48);">(</span>g_hFullItems<span style="color: rgb(128, 128, 48);">,</span>INFINITE<span style="color: rgb(128, 128, 48);">)</span>         <span style="color: rgb(128, 0, 128);">;</span>
                   <span style="color: rgb(64, 0, 0);">WaitForSingleObject</span><span style="color: rgb(128, 128, 48);">(</span>g_hMutex<span style="color: rgb(128, 128, 48);">,</span>INFINITE<span style="color: rgb(128, 128, 48);">)</span>            <span style="color: rgb(128, 0, 128);">;</span>
            Take<span style="color: rgb(128, 128, 48);">(</span><span style="color: rgb(128, 128, 48);">)</span><span style="color: rgb(128, 0, 128);">;</span>
            Consume<span style="color: rgb(128, 128, 48);">(</span><span style="color: rgb(128, 128, 48);">)</span><span style="color: rgb(128, 0, 128);">;</span>
                 <span style="color: rgb(64, 0, 0);">ReleaseMutex</span><span style="color: rgb(128, 128, 48);">(</span>g_hMutex<span style="color: rgb(128, 128, 48);">)</span>                        <span style="color: rgb(128, 0, 128);">;</span>
                  <span style="color: rgb(64, 0, 0);">ReleaseSemaphore</span><span style="color: rgb(128, 128, 48);">(</span>g_hEmptyItems<span style="color: rgb(128, 128, 48);">,</span><span style="color: rgb(119, 140, 119);">1</span><span style="color: rgb(128, 128, 48);">,</span><span style="color: rgb(125, 0, 69);">NULL</span><span style="color: rgb(128, 128, 48);">)</span>          <span style="color: rgb(128, 0, 128);">;</span>
        <span style="color: rgb(128, 0, 128);">}</span>
        <span style="color: rgb(80, 128, 80); "><strong>return</strong></span> <span style="color: rgb(119, 140, 119);">0</span><span style="color: rgb(128, 0, 128);">;</span>
   <span style="color: rgb(128, 0, 128);">}</span>
     
    <span style="color: rgb(185, 105, 105);">//生产一个产品。简单模拟了一下，仅输出新产品的ID号</span>
    <span style="color: rgb(80, 128, 80); "><strong>void</strong></span> Produce<span style="color: rgb(128, 128, 48);">(</span><span style="color: rgb(128, 128, 48);">)</span>
    <span style="color: rgb(128, 0, 128);">{</span>
		<span style="color: rgb(96, 48, 0);">printf</span><span style="color: rgb(128, 128, 48);">(</span><span style="color: rgb(128, 0, 0);">&quot;</span><span style="color: rgb(170, 51, 51); "><strong>\n</strong></span><span style="color: rgb(204, 85, 85);">Producing </span><span style="color: rgb(0, 121, 151);">%d</span><span style="color: rgb(204, 85, 85);"> ...</span><span style="color: rgb(128, 0, 0);">&quot;</span><span style="color: rgb(128, 128, 48);">,</span> <span style="color: rgb(128, 128, 48);">+</span><span style="color: rgb(128, 128, 48);">+</span>ProductID<span style="color: rgb(128, 128, 48);">)</span><span style="color: rgb(128, 0, 128);">;</span>
		<span style="color: rgb(96, 48, 0);">printf</span><span style="color: rgb(128, 128, 48);">(</span><span style="color: rgb(128, 0, 0);">&quot;</span><span style="color: rgb(204, 85, 85);">Succeed</span><span style="color: rgb(170, 51, 51); "><strong>\n</strong></span><span style="color: rgb(128, 0, 0);">&quot;</span><span style="color: rgb(128, 128, 48);">)</span><span style="color: rgb(128, 0, 128);">;</span>
   <span style="color: rgb(128, 0, 128);">}</span>
     
    <span style="color: rgb(185, 105, 105);">//把新生产的产品放入缓冲区</span>
    <span style="color: rgb(80, 128, 80); "><strong>void</strong></span> Append<span style="color: rgb(128, 128, 48);">(</span><span style="color: rgb(128, 128, 48);">)</span>
    <span style="color: rgb(128, 0, 128);">{</span>
			  <span style="color: rgb(80, 128, 80); "><strong>int</strong></span> i<span style="color: rgb(128, 0, 128);">;</span>
			  <span style="color: rgb(96, 48, 0);">printf</span><span style="color: rgb(128, 128, 48);">(</span><span style="color: rgb(128, 0, 0);">&quot;</span><span style="color: rgb(204, 85, 85);">Appending a product ...</span><span style="color: rgb(128, 0, 0);">&quot;</span><span style="color: rgb(128, 128, 48);">)</span><span style="color: rgb(128, 0, 128);">;</span>
      g_buffer<span style="color: rgb(128, 128, 48);">[</span>in<span style="color: rgb(128, 128, 48);">]</span> <span style="color: rgb(128, 128, 48);">=</span> ProductID<span style="color: rgb(128, 0, 128);">;</span>
      in <span style="color: rgb(128, 128, 48);">=</span> <span style="color: rgb(128, 128, 48);">(</span>in<span style="color: rgb(128, 128, 48);">+</span><span style="color: rgb(119, 140, 119);">1</span><span style="color: rgb(128, 128, 48);">)</span><span style="color: rgb(128, 128, 48);">%</span>SIZE_OF_BUFFER<span style="color: rgb(128, 0, 128);">;</span>
	  <span style="color: rgb(96, 48, 0);">printf</span><span style="color: rgb(128, 128, 48);">(</span><span style="color: rgb(128, 0, 0);">&quot;</span><span style="color: rgb(204, 85, 85);">Succeed</span><span style="color: rgb(170, 51, 51); "><strong>\n</strong></span><span style="color: rgb(128, 0, 0);">&quot;</span><span style="color: rgb(128, 128, 48);">)</span><span style="color: rgb(128, 0, 128);">;</span>

    
      <span style="color: rgb(185, 105, 105);">//输出缓冲区当前的状态</span>

      <span style="color: rgb(80, 128, 80); "><strong>for</strong></span> <span style="color: rgb(128, 128, 48);">(</span>i<span style="color: rgb(128, 128, 48);">=</span><span style="color: rgb(119, 140, 119);">0</span><span style="color: rgb(128, 0, 128);">;</span>i<span style="color: rgb(128, 128, 48);">&lt;</span>SIZE_OF_BUFFER<span style="color: rgb(128, 0, 128);">;</span><span style="color: rgb(128, 128, 48);">+</span><span style="color: rgb(128, 128, 48);">+</span>i<span style="color: rgb(128, 128, 48);">)</span>
	  <span style="color: rgb(128, 0, 128);">{</span>
		  <span style="color: rgb(96, 48, 0);">printf</span><span style="color: rgb(128, 128, 48);">(</span><span style="color: rgb(128, 0, 0);">&quot;</span><span style="color: rgb(0, 121, 151);">%d</span><span style="color: rgb(204, 85, 85);">:</span><span style="color: rgb(128, 0, 0);">&quot;</span><span style="color: rgb(128, 128, 48);">,</span>i<span style="color: rgb(128, 128, 48);">)</span><span style="color: rgb(128, 0, 128);">;</span>

           <span style="color: rgb(80, 128, 80); "><strong>if</strong></span> <span style="color: rgb(128, 128, 48);">(</span>g_buffer<span style="color: rgb(128, 128, 48);">[</span>i<span style="color: rgb(128, 128, 48);">]</span><span style="color: rgb(128, 128, 48);">=</span><span style="color: rgb(128, 128, 48);">=</span><span style="color: rgb(128, 128, 48);">-</span><span style="color: rgb(119, 140, 119);">1</span><span style="color: rgb(128, 128, 48);">)</span>
			   <span style="color: rgb(96, 48, 0);">printf</span><span style="color: rgb(128, 128, 48);">(</span><span style="color: rgb(128, 0, 0);">&quot;</span><span style="color: rgb(204, 85, 85);">null</span><span style="color: rgb(128, 0, 0);">&quot;</span><span style="color: rgb(128, 128, 48);">)</span><span style="color: rgb(128, 0, 128);">;</span>
           <span style="color: rgb(80, 128, 80); "><strong>else</strong></span>
			   <span style="color: rgb(96, 48, 0);">printf</span><span style="color: rgb(128, 128, 48);">(</span><span style="color: rgb(128, 0, 0);">&quot;</span><span style="color: rgb(0, 121, 151);">%d</span><span style="color: rgb(128, 0, 0);">&quot;</span><span style="color: rgb(128, 128, 48);">,</span>g_buffer<span style="color: rgb(128, 128, 48);">[</span>i<span style="color: rgb(128, 128, 48);">]</span><span style="color: rgb(128, 128, 48);">)</span><span style="color: rgb(128, 0, 128);">;</span>
		     <span style="color: rgb(80, 128, 80); "><strong>if</strong></span> <span style="color: rgb(128, 128, 48);">(</span>i<span style="color: rgb(128, 128, 48);">=</span><span style="color: rgb(128, 128, 48);">=</span>in<span style="color: rgb(128, 128, 48);">)</span> <span style="color: rgb(96, 48, 0);">printf</span><span style="color: rgb(128, 128, 48);">(</span><span style="color: rgb(128, 0, 0);">&quot;</span><span style="color: rgb(170, 51, 51); "><strong>\t</strong></span><span style="color: rgb(204, 85, 85);">&lt;-- 生产</span><span style="color: rgb(128, 0, 0);">&quot;</span><span style="color: rgb(128, 128, 48);">)</span><span style="color: rgb(128, 0, 128);">;</span>
			 <span style="color: rgb(80, 128, 80); "><strong>if</strong></span> <span style="color: rgb(128, 128, 48);">(</span>i<span style="color: rgb(128, 128, 48);">=</span><span style="color: rgb(128, 128, 48);">=</span>out<span style="color: rgb(128, 128, 48);">)</span> <span style="color: rgb(96, 48, 0);">printf</span><span style="color: rgb(128, 128, 48);">(</span><span style="color: rgb(128, 0, 0);">&quot;</span><span style="color: rgb(170, 51, 51); "><strong>\t</strong></span><span style="color: rgb(204, 85, 85);">&lt;-- 消费</span><span style="color: rgb(128, 0, 0);">&quot;</span><span style="color: rgb(128, 128, 48);">)</span><span style="color: rgb(128, 0, 128);">;</span>
			 <span style="color: rgb(96, 48, 0);">printf</span><span style="color: rgb(128, 128, 48);">(</span><span style="color: rgb(128, 0, 0);">&quot;</span><span style="color: rgb(170, 51, 51); "><strong>\n</strong></span><span style="color: rgb(128, 0, 0);">&quot;</span><span style="color: rgb(128, 128, 48);">)</span><span style="color: rgb(128, 0, 128);">;</span>
        <span style="color: rgb(128, 0, 128);">}</span>
    <span style="color: rgb(128, 0, 128);">}</span>
    
   <span style="color: rgb(185, 105, 105);">//从缓冲区中取出一个产品</span>
   <span style="color: rgb(80, 128, 80); "><strong>void</strong></span> Take<span style="color: rgb(128, 128, 48);">(</span><span style="color: rgb(128, 128, 48);">)</span>
   <span style="color: rgb(128, 0, 128);">{</span>
	   <span style="color: rgb(80, 128, 80); "><strong>int</strong></span> i<span style="color: rgb(128, 0, 128);">;</span>
	   <span style="color: rgb(96, 48, 0);">printf</span><span style="color: rgb(128, 128, 48);">(</span><span style="color: rgb(128, 0, 0);">&quot;</span><span style="color: rgb(170, 51, 51); "><strong>\n</strong></span><span style="color: rgb(204, 85, 85);">Taking a product ...</span><span style="color: rgb(128, 0, 0);">&quot;</span><span style="color: rgb(128, 128, 48);">)</span><span style="color: rgb(128, 0, 128);">;</span>
       ConsumeID <span style="color: rgb(128, 128, 48);">=</span> g_buffer<span style="color: rgb(128, 128, 48);">[</span>out<span style="color: rgb(128, 128, 48);">]</span><span style="color: rgb(128, 0, 128);">;</span>
       g_buffer<span style="color: rgb(128, 128, 48);">[</span>out<span style="color: rgb(128, 128, 48);">]</span><span style="color: rgb(128, 128, 48);">=</span> <span style="color: rgb(128, 128, 48);">-</span><span style="color: rgb(119, 140, 119);">1</span><span style="color: rgb(128, 0, 128);">;</span>
       out <span style="color: rgb(128, 128, 48);">=</span> <span style="color: rgb(128, 128, 48);">(</span>out<span style="color: rgb(128, 128, 48);">+</span><span style="color: rgb(119, 140, 119);">1</span><span style="color: rgb(128, 128, 48);">)</span><span style="color: rgb(128, 128, 48);">%</span>SIZE_OF_BUFFER<span style="color: rgb(128, 0, 128);">;</span>
	   <span style="color: rgb(96, 48, 0);">printf</span><span style="color: rgb(128, 128, 48);">(</span><span style="color: rgb(128, 0, 0);">&quot;</span><span style="color: rgb(0, 121, 151);">%d</span><span style="color: rgb(204, 85, 85);">--Succeed</span><span style="color: rgb(170, 51, 51); "><strong>\n</strong></span><span style="color: rgb(128, 0, 0);">&quot;</span><span style="color: rgb(128, 128, 48);">,</span> ConsumeID<span style="color: rgb(128, 128, 48);">)</span><span style="color: rgb(128, 0, 128);">;</span>
	   
       <span style="color: rgb(185, 105, 105);">//输出缓冲区当前的状态</span>
       <span style="color: rgb(80, 128, 80); "><strong>for</strong></span> <span style="color: rgb(128, 128, 48);">(</span>i<span style="color: rgb(128, 128, 48);">=</span><span style="color: rgb(119, 140, 119);">0</span><span style="color: rgb(128, 0, 128);">;</span>i<span style="color: rgb(128, 128, 48);">&lt;</span>SIZE_OF_BUFFER<span style="color: rgb(128, 0, 128);">;</span><span style="color: rgb(128, 128, 48);">+</span><span style="color: rgb(128, 128, 48);">+</span>i<span style="color: rgb(128, 128, 48);">)</span><span style="color: rgb(128, 0, 128);">{</span>
		   <span style="color: rgb(96, 48, 0);">printf</span><span style="color: rgb(128, 128, 48);">(</span><span style="color: rgb(128, 0, 0);">&quot;</span><span style="color: rgb(0, 121, 151);">%d</span><span style="color: rgb(204, 85, 85);">:</span><span style="color: rgb(128, 0, 0);">&quot;</span><span style="color: rgb(128, 128, 48);">,</span>i<span style="color: rgb(128, 128, 48);">)</span><span style="color: rgb(128, 0, 128);">;</span>
            <span style="color: rgb(80, 128, 80); "><strong>if</strong></span> <span style="color: rgb(128, 128, 48);">(</span>g_buffer<span style="color: rgb(128, 128, 48);">[</span>i<span style="color: rgb(128, 128, 48);">]</span><span style="color: rgb(128, 128, 48);">=</span><span style="color: rgb(128, 128, 48);">=</span><span style="color: rgb(128, 128, 48);">-</span><span style="color: rgb(119, 140, 119);">1</span><span style="color: rgb(128, 128, 48);">)</span>
				 <span style="color: rgb(96, 48, 0);">printf</span><span style="color: rgb(128, 128, 48);">(</span><span style="color: rgb(128, 0, 0);">&quot;</span><span style="color: rgb(204, 85, 85);">null</span><span style="color: rgb(128, 0, 0);">&quot;</span><span style="color: rgb(128, 128, 48);">)</span><span style="color: rgb(128, 0, 128);">;</span>
            <span style="color: rgb(80, 128, 80); "><strong>else</strong></span>
				<span style="color: rgb(96, 48, 0);">printf</span><span style="color: rgb(128, 128, 48);">(</span><span style="color: rgb(128, 0, 0);">&quot;</span><span style="color: rgb(0, 121, 151);">%d</span><span style="color: rgb(128, 0, 0);">&quot;</span><span style="color: rgb(128, 128, 48);">,</span>g_buffer<span style="color: rgb(128, 128, 48);">[</span>i<span style="color: rgb(128, 128, 48);">]</span><span style="color: rgb(128, 128, 48);">)</span><span style="color: rgb(128, 0, 128);">;</span>
			<span style="color: rgb(80, 128, 80); "><strong>if</strong></span> <span style="color: rgb(128, 128, 48);">(</span>i<span style="color: rgb(128, 128, 48);">=</span><span style="color: rgb(128, 128, 48);">=</span>in<span style="color: rgb(128, 128, 48);">)</span> <span style="color: rgb(96, 48, 0);">printf</span><span style="color: rgb(128, 128, 48);">(</span><span style="color: rgb(128, 0, 0);">&quot;</span><span style="color: rgb(170, 51, 51); "><strong>\t</strong></span><span style="color: rgb(204, 85, 85);">&lt;-- 生产</span><span style="color: rgb(128, 0, 0);">&quot;</span><span style="color: rgb(128, 128, 48);">)</span><span style="color: rgb(128, 0, 128);">;</span>
			<span style="color: rgb(80, 128, 80); "><strong>if</strong></span> <span style="color: rgb(128, 128, 48);">(</span>i<span style="color: rgb(128, 128, 48);">=</span><span style="color: rgb(128, 128, 48);">=</span>out<span style="color: rgb(128, 128, 48);">)</span> <span style="color: rgb(96, 48, 0);">printf</span><span style="color: rgb(128, 128, 48);">(</span><span style="color: rgb(128, 0, 0);">&quot;</span><span style="color: rgb(170, 51, 51); "><strong>\t</strong></span><span style="color: rgb(204, 85, 85);">&lt;-- 消费</span><span style="color: rgb(128, 0, 0);">&quot;</span><span style="color: rgb(128, 128, 48);">)</span><span style="color: rgb(128, 0, 128);">;</span>
			<span style="color: rgb(96, 48, 0);">printf</span><span style="color: rgb(128, 128, 48);">(</span><span style="color: rgb(128, 0, 0);">&quot;</span><span style="color: rgb(170, 51, 51); "><strong>\n</strong></span><span style="color: rgb(128, 0, 0);">&quot;</span><span style="color: rgb(128, 128, 48);">)</span><span style="color: rgb(128, 0, 128);">;</span>

       <span style="color: rgb(128, 0, 128);">}</span>
    <span style="color: rgb(128, 0, 128);">}</span>
    
    <span style="color: rgb(185, 105, 105);">//消耗一个产品</span>
    <span style="color: rgb(80, 128, 80); "><strong>void</strong></span> Consume<span style="color: rgb(128, 128, 48);">(</span><span style="color: rgb(128, 128, 48);">)</span>
    <span style="color: rgb(128, 0, 128);">{</span>
		<span style="color: rgb(96, 48, 0);">printf</span><span style="color: rgb(128, 128, 48);">(</span><span style="color: rgb(128, 0, 0);">&quot;</span><span style="color: rgb(204, 85, 85);">Consuming </span><span style="color: rgb(0, 121, 151);">%d</span><span style="color: rgb(204, 85, 85);"> </span><span style="color: rgb(128, 0, 0);">&quot;</span><span style="color: rgb(128, 128, 48);">,</span> ConsumeID<span style="color: rgb(128, 128, 48);">)</span><span style="color: rgb(128, 0, 128);">;</span>
		<span style="color: rgb(96, 48, 0);">printf</span><span style="color: rgb(128, 128, 48);">(</span><span style="color: rgb(128, 0, 0);">&quot;</span><span style="color: rgb(204, 85, 85);">Succeed</span><span style="color: rgb(170, 51, 51); "><strong>\n</strong></span><span style="color: rgb(128, 0, 0);">&quot;</span><span style="color: rgb(128, 128, 48);">)</span><span style="color: rgb(128, 0, 128);">;</span>
    <span style="color: rgb(128, 0, 128);">}</span></pre><br /></p>