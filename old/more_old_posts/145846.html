



<br /><br />/**************************************<br />Webee Zigbee 开发板<br />串口通信驱动<br />波特率：115200bps<br />**************************************/<br /><br /><br />#include &lt;ioCC2530.h&gt;<br />#include &lt;string.h&gt;<br /><br /><br />#define uint unsigned int<br />#define uchar unsigned char<br /><br /><br />//函数声明<br />void Delayms(uint xms);<span style="white-space:pre">		</span>//延时函数<br />void InitUart(); &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;//初始化串口<br />void Uart_Send(char *Data,int len);<br />int &nbsp;Uart_Receive();<br /><br /><br />char Rxdata[100];<br />uchar Rxlen = 0;<br /><br /><br />void Delayms(uint xms)<br />{<br />&nbsp;uint i,j;<br />&nbsp;for(i=xms;i&gt;0;i--)<br />&nbsp; &nbsp;for(j=587;j&gt;0;j--);<br />}&nbsp;<br /><br /><br /><br /><br /><br /><br />/****************************************************************&nbsp;<br />&nbsp; &nbsp;串口初始化函数 &nbsp; &nbsp;&nbsp;<br />***********************************************************/<br />void InitUart()<br />{<br />&nbsp; &nbsp; CLKCONCMD &amp;= ~0x40; // 设置系统时钟源为 32MHZ晶振<br />&nbsp; &nbsp; while(CLKCONSTA &amp; 0x40); &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // 等待晶振稳定&nbsp;<br />&nbsp; &nbsp; CLKCONCMD &amp;= ~0x47; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// 设置系统主时钟频率为 32MHZ<br /><br /><br />&nbsp; &nbsp; PERCFG = 0x00; &nbsp; &nbsp; &nbsp; &nbsp;//位置1 P0口&nbsp;<br />&nbsp; &nbsp; P0SEL = 0x3c; &nbsp; &nbsp; &nbsp; &nbsp;//P0_2,P0_3,P0_4,P0_5用作串口,第二功能&nbsp;<br />&nbsp; &nbsp; P2DIR &amp;= ~0XC0; &nbsp; &nbsp; &nbsp;//P0 优先作为UART0 ，优先级<br />&nbsp;<br />&nbsp; &nbsp; U0CSR |= 0x80; &nbsp; &nbsp; &nbsp; //UART 方式&nbsp;<br />&nbsp; &nbsp; U0GCR |= 11; &nbsp; &nbsp; &nbsp; &nbsp; //U0GCR与U0BAUD配合 &nbsp; &nbsp;&nbsp;<br />&nbsp; &nbsp; U0BAUD |= 216; &nbsp; &nbsp; &nbsp; // 波特率设为115200&nbsp;<br />&nbsp; &nbsp; UTX0IF = 0; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;//UART0 TX 中断标志初始置位1 &nbsp;（收发时候）<br />&nbsp; &nbsp; U0CSR |= 0X40; &nbsp; &nbsp; &nbsp; //允许接收&nbsp;<br />&nbsp; &nbsp; IEN0 |= 0x84; &nbsp; &nbsp; &nbsp; &nbsp;// 开总中断，接收中断 &nbsp; &nbsp;<br />}<br /><br /><br />void Uart_Send(char *Data,int len)&nbsp;<br />{<br />&nbsp;U0CSR &amp;= ~0x40;<br />&nbsp;{&nbsp;<br />&nbsp; int j;&nbsp;<br />&nbsp; for(j=0;j&lt;len;j++)&nbsp;<br />&nbsp; {&nbsp;<br />&nbsp; &nbsp; U0DBUF = *Data++;&nbsp;<br />&nbsp; &nbsp; while(UTX0IF == 0);<br />&nbsp; &nbsp; UTX0IF = 0;&nbsp;<br />&nbsp; }&nbsp;<br />&nbsp;}<br />&nbsp;U0CSR |= 0x40;<br />}<br /><br /><br />int Uart_Receive(char *p)<br />{<br />&nbsp;uint i, a = Rxlen;<br />&nbsp;for (i=0;i&lt;Rxlen;++i)<br /><span style="white-space:pre">	</span>*(p+i) = Rxdata[i];<br />&nbsp;Rxlen = 0;<br />&nbsp;return a;<br />}<br /><br /><br />#pragma vector = URX0_VECTOR&nbsp;<br />&nbsp; __interrupt void UART0_ISR(void)&nbsp;<br />&nbsp;{&nbsp;<br />&nbsp; URX0IF = 0; &nbsp; &nbsp;// 清中断标志&nbsp;<br />&nbsp; Rxdata[Rxlen++] = U0DBUF; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<br />&nbsp;}