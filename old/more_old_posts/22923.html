

<blockquote style="margin: 20px 0px; padding: 0px 20px; border-width: 0px 0px 0px 4px; border-left-style: solid; border-left-color: rgb(76, 175, 80); box-sizing: border-box; -webkit-font-smoothing: subpixel-antialiased; color: rgb(119, 119, 119); position: relative; width: 656.75px; font-family: Exo, -apple-system, &quot;Open Sans&quot;, HelveticaNeue-Light, &quot;Helvetica Neue Light&quot;, &quot;Helvetica Neue&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 22.4px;"><p style="margin: 0px; padding: 0px; border: 0px; box-sizing: border-box; -webkit-font-smoothing: subpixel-antialiased;">首先解释下什么是AJC，其实就是alxwvj_judge_core。vj系统本身设计成可以支持多种oj，所以又一个目录下专门放置各个oj的各种采集模块。ajc其实也是写成这种结构的一个模块，只不过它是一个本地的oj模块。没错，vj<br style="margin: 0px; padding: 0px; border: 0px; box-sizing: border-box; -webkit-font-smoothing: subpixel-antialiased;" />＋ ajc秒变oj。</p></blockquote><blockquote style="margin: 20px 0px; padding: 0px 20px; border-width: 0px 0px 0px 4px; border-left-style: solid; border-left-color: rgb(76, 175, 80); box-sizing: border-box; -webkit-font-smoothing: subpixel-antialiased; color: rgb(119, 119, 119); position: relative; width: 656.75px; font-family: Exo, -apple-system, &quot;Open Sans&quot;, HelveticaNeue-Light, &quot;Helvetica Neue Light&quot;, &quot;Helvetica Neue&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 22.4px;"><p style="margin: 0px; padding: 0px; border: 0px; box-sizing: border-box; -webkit-font-smoothing: subpixel-antialiased;">这里我借鉴了几个开源项目。其一是<a href="https://github.com/lodevil/Lo-runner" style="margin: 0px; padding: 0px; border: 0px; box-sizing: border-box; -webkit-font-smoothing: subpixel-antialiased; color: rgb(245, 146, 0); text-decoration: none; transition: all 0.24s; overflow: hidden; text-overflow: ellipsis; word-spacing: normal; word-break: break-word; word-wrap: break-word;">lo-runner</a>,一个用python写的oj核心，所以其实我大部分时间是在处理逻辑问题而不是处理安全性问题。其二就是<a href="https://github.com/zhblue/hustoj" style="margin: 0px; padding: 0px; border: 0px; box-sizing: border-box; -webkit-font-smoothing: subpixel-antialiased; color: rgb(245, 146, 0); text-decoration: none; transition: all 0.24s; overflow: hidden; text-overflow: ellipsis; word-spacing: normal; word-break: break-word; word-wrap: break-word;">hustoj</a>的源码，因为基本现在大部分学校的校内oj都是基于hustoj搭建的。</p></blockquote><blockquote style="margin: 20px 0px; padding: 0px 20px; border-width: 0px 0px 0px 4px; border-left-style: solid; border-left-color: rgb(76, 175, 80); box-sizing: border-box; -webkit-font-smoothing: subpixel-antialiased; color: rgb(119, 119, 119); position: relative; width: 656.75px; font-family: Exo, -apple-system, &quot;Open Sans&quot;, HelveticaNeue-Light, &quot;Helvetica Neue Light&quot;, &quot;Helvetica Neue&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 22.4px;"><p style="margin: 0px 0px 10px; padding: 0px; border: 0px; box-sizing: border-box; -webkit-font-smoothing: subpixel-antialiased;">这里简单说几下oj核心的实现流程：</p><ol style="margin: 10px 0px 0px; padding: 0px 0px 0px 30px; border: 0px; box-sizing: border-box; -webkit-font-smoothing: subpixel-antialiased;"><li style="margin: 0px; padding: 0px; border: 0px; box-sizing: border-box; -webkit-font-smoothing: subpixel-antialiased; word-wrap: break-word;">检测数据库提交的Record并且入队列并更新数据库状态为waiting</li><li style="margin: 0px; padding: 0px; border: 0px; box-sizing: border-box; -webkit-font-smoothing: subpixel-antialiased; word-wrap: break-word;">多线程worker从队列取任务</li><li style="margin: 0px; padding: 0px; border: 0px; box-sizing: border-box; -webkit-font-smoothing: subpixel-antialiased; word-wrap: break-word;">取到任务的worker取相应代码和数据，编译执行对比结果</li><li style="margin: 0px; padding: 0px; border: 0px; box-sizing: border-box; -webkit-font-smoothing: subpixel-antialiased; word-wrap: break-word;">worker更新相应数据库状态</li></ol></blockquote><blockquote style="margin: 20px 0px; padding: 0px 20px; border-width: 0px 0px 0px 4px; border-left-style: solid; border-left-color: rgb(76, 175, 80); box-sizing: border-box; -webkit-font-smoothing: subpixel-antialiased; color: rgb(119, 119, 119); position: relative; width: 656.75px; font-family: Exo, -apple-system, &quot;Open Sans&quot;, HelveticaNeue-Light, &quot;Helvetica Neue Light&quot;, &quot;Helvetica Neue&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 22.4px;"><p style="margin: 0px 0px 10px; padding: 0px; border: 0px; box-sizing: border-box; -webkit-font-smoothing: subpixel-antialiased;">其中比较关键的两个问题就是多线程和评测安全性：</p><ol style="margin: 10px 0px 0px; padding: 0px 0px 0px 30px; border: 0px; box-sizing: border-box; -webkit-font-smoothing: subpixel-antialiased;"><li style="margin: 0px; padding: 0px; border: 0px; box-sizing: border-box; -webkit-font-smoothing: subpixel-antialiased; word-wrap: break-word;">直接使用python2的多线程，受限制于GIL，此部分代码移植自<a href="https://github.com/ma6174/acmjudger" style="margin: 0px; padding: 0px; border: 0px; box-sizing: border-box; -webkit-font-smoothing: subpixel-antialiased; color: rgb(245, 146, 0); text-decoration: none; transition: all 0.24s; overflow: hidden; text-overflow: ellipsis; word-spacing: normal; word-break: break-word; word-wrap: break-word;">amcjudger</a></li><li style="margin: 0px; padding: 0px; border: 0px; box-sizing: border-box; -webkit-font-smoothing: subpixel-antialiased; word-wrap: break-word;">安全性问题，原来的acmjudger里面解决的不好。查看文档发现lo-runner提供了文件白名单和系统调用白名单。参考了hustoj的白名单(写的太乱Orz...)，最后才用了这份白名单(32位-static编译)：</li></ol></blockquote><pre style="margin-top: 0.95em; margin-bottom: 0.95em; padding: 1em; border: 0px; box-sizing: border-box; -webkit-font-smoothing: subpixel-antialiased; font-size: 13px; font-family: inconsolata, Consolas, monospace, sans-serif; word-wrap: break-word; line-height: 19px; overflow: auto; border-radius: 3px; width: 656.75px; white-space: pre-wrap; color: rgb(51, 51, 51); background: rgb(248, 248, 248);"><code style="margin: 0px; padding: 0px; border: 0px; box-sizing: border-box; -webkit-font-smoothing: subpixel-antialiased; font-size: 1em; font-family: inconsolata, Consolas, monospace, sans-serif; word-wrap: break-word; color: rgb(65, 65, 65); white-space: inherit; border-radius: 2px; word-break: break-all; background: 0px center;">| sys_call         | id     |
|:----------------:|:------:|
| name             | 122    |
| brk              | 45     |
| set_thread_area  | 243    |
| readlink         | 85     |
| access           | 33     |
| fstat64          | 197    |
| mmap2            | 192    |
| exit_group       | 252    |
</code></pre><blockquote style="margin: 20px 0px; padding: 0px 20px; border-width: 0px 0px 0px 4px; border-left-style: solid; border-left-color: rgb(76, 175, 80); box-sizing: border-box; -webkit-font-smoothing: subpixel-antialiased; color: rgb(119, 119, 119); position: relative; width: 656.75px; font-family: Exo, -apple-system, &quot;Open Sans&quot;, HelveticaNeue-Light, &quot;Helvetica Neue Light&quot;, &quot;Helvetica Neue&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 22.4px;"><p style="margin: 0px; padding: 0px; border: 0px; box-sizing: border-box; -webkit-font-smoothing: subpixel-antialiased;">这份名单其实很好采集，更改lo-runner的源码syscalls拦截部分，一律放行并且printf()，调用的时候开启白名单即可，如图：<br style="margin: 0px; padding: 0px; border: 0px; box-sizing: border-box; -webkit-font-smoothing: subpixel-antialiased;" /><img src="https://ww4.sinaimg.cn/large/7eb49035jw1f55igc5thaj20gk07twfe.jpg" alt="pyuse.png" style="margin: 0px auto; padding: 0px; border: 0px; box-sizing: border-box; -webkit-font-smoothing: subpixel-antialiased; position: relative; display: block; max-width: 100%; height: auto; overflow: hidden; transition: all 0.24s ease;" width="596" height="281" /></p></blockquote><blockquote style="margin: 20px 0px; padding: 0px 20px; border-width: 0px 0px 0px 4px; border-left-style: solid; border-left-color: rgb(76, 175, 80); box-sizing: border-box; -webkit-font-smoothing: subpixel-antialiased; color: rgb(119, 119, 119); position: relative; width: 656.75px; font-family: Exo, -apple-system, &quot;Open Sans&quot;, HelveticaNeue-Light, &quot;Helvetica Neue Light&quot;, &quot;Helvetica Neue&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 22.4px;"><p style="margin: 0px; padding: 0px; border: 0px; box-sizing: border-box; -webkit-font-smoothing: subpixel-antialiased;">github代码中的白名单是混合了32位和64位的表只保证两张架构下能够运行但是安全性会有问题！需要具体更改！</p></blockquote><blockquote style="margin: 20px 0px; padding: 0px 20px; border-width: 0px 0px 0px 4px; border-left-style: solid; border-left-color: rgb(76, 175, 80); box-sizing: border-box; -webkit-font-smoothing: subpixel-antialiased; color: rgb(119, 119, 119); position: relative; width: 656.75px; font-family: Exo, -apple-system, &quot;Open Sans&quot;, HelveticaNeue-Light, &quot;Helvetica Neue Light&quot;, &quot;Helvetica Neue&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 22.4px;"><p style="margin: 0px; padding: 0px; border: 0px; box-sizing: border-box; -webkit-font-smoothing: subpixel-antialiased;">直接放地址吧：<a href="https://github.com/springhack/alxwvj_judge_core" style="margin: 0px; padding: 0px; border: 0px; box-sizing: border-box; -webkit-font-smoothing: subpixel-antialiased; color: rgb(245, 146, 0); text-decoration: none; transition: all 0.24s; overflow: hidden; text-overflow: ellipsis; word-spacing: normal; word-break: break-word; word-wrap: break-word;">Github</a></p></blockquote><blockquote style="margin: 20px 0px; padding: 0px 20px; border-width: 0px 0px 0px 4px; border-left-style: solid; border-left-color: rgb(76, 175, 80); box-sizing: border-box; -webkit-font-smoothing: subpixel-antialiased; color: rgb(119, 119, 119); position: relative; width: 656.75px; font-family: Exo, -apple-system, &quot;Open Sans&quot;, HelveticaNeue-Light, &quot;Helvetica Neue Light&quot;, &quot;Helvetica Neue&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 22.4px;"><p style="margin: 0px; padding: 0px; border: 0px; box-sizing: border-box; -webkit-font-smoothing: subpixel-antialiased;">贴上编译的核心部分，超时自动结束防止 #include&lt;/dev/null&gt; 等卡编译的操作：</p></blockquote><pre style="margin-top: 0.95em; margin-bottom: 0.95em; padding: 1em; border: 0px; box-sizing: border-box; -webkit-font-smoothing: subpixel-antialiased; font-size: 13px; font-family: inconsolata, Consolas, monospace, sans-serif; word-wrap: break-word; line-height: 19px; overflow: auto; border-radius: 3px; width: 656.75px; white-space: pre-wrap; color: rgb(51, 51, 51); background: rgb(248, 248, 248);"><code style="margin: 0px; padding: 0px; border: 0px; box-sizing: border-box; -webkit-font-smoothing: subpixel-antialiased; font-size: 1em; font-family: inconsolata, Consolas, monospace, sans-serif; word-wrap: break-word; color: rgb(65, 65, 65); white-space: inherit; border-radius: 2px; word-break: break-all; background: 0px center;">p = subprocess.Popen(
    build_cmd[language],
    shell=True,
    cwd=dir_work,
    stdout=subprocess.PIPE,
    stderr=subprocess.PIPE,
    close_fds=True)

kill_proc = lambda p: p.kill()
timer = threading.Timer(5, kill_proc, [p])
try:
    timer.start()
    out, err = p.communicate()  # 获取编译错误信息
finally:
    timer.cancel()

if p.returncode == 0:  # 返回值为0,编译成功
    return True</code></pre>